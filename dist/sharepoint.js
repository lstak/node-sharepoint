"use strict";var fs=require("fs"),qs=require("querystring"),xml2js=require("xml2js"),http=require("http"),https=require("https"),urlparse=require("url").parse,samlRequestTemplate=fs.readFileSync(__dirname+"/SAML.xml","utf8"),SP;!function(t){var e=function(){function t(t,e,n){this.List=t,this.Accept=e,this.Method=n}return t}(),n=function(){function t(t,e){this.Name=t,this.Value=e}return t}(),o=function(){function o(t){this.Url=urlparse(t),this.Host=this.Url.host,this.Path=this.Url.path,this.Protocol=this.Url.protocol,this.STS={Host:"login.microsoftonline.com",Path:"/extSTS.srf"},this.Login="/_forms/default.aspx?wa=wsignin1.0",this.ODataEndPoint="/_vti_bin/ListData.svc/"}return o.prototype.SignIn=function(t,e,n){var r=this,i={username:t,password:e,sts:r.STS,endpoint:r.Url.protocol+"//"+r.Url.hostname+r.Login};o._RequestToken(i,function(t,e){return t?void n(t,null):(r.FedAuth=e.FedAuth,r.rtFa=e.rtFa,void n(null,e))})},o.prototype.GetList=function(e){var n=new t.List(this,e);return n},o.prototype.Request=function(t,e){},o.prototype.Metadata=function(t){var n=new e("$metadata","application/xml","GET");this.Request(n,t)},o._BuildSamlRequest=function(t){var e=samlRequestTemplate;for(var n in t)e=e.replace("["+n+"]",t[n]);return e},o._ParseXml=function(t,e){var n=new xml2js.Parser({emptyTag:""});n.on("end",function(t){e&&e(t)}),n.parseString(t)},o._ParseCookie=function(t){var e=t.split("; "),o=new n("","");return e.forEach(function(t,e){var n=t.indexOf("="),r=n>0?t.substring(0,n):t,i=n>0?t.substring(n+1):void 0;0===e?(o.Name=r,o.Value=i):o.Name=i}),o},o._ParseCookies=function(t){var e=this,n=[];return t&&t.forEach(function(t){var o=e._ParseCookie(t);n.push(o)}),n},o._GetCookie=function(t,e){for(var n,o=t.length,r=0;o>r;r++)if(n=t[r],n.name==e)return n;return void 0},o._SubmitToken=function(t,e){var n=t.token,r=urlparse(t.endpoint),i="https:"==r.protocol,s={method:"POST",host:r.hostname,path:r.path,headers:{"User-Agent":"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)"}},a=i?https:http,u=a.request(s,function(t){var n="";t.setEncoding("utf8"),t.on("data",function(t){n+=t}),t.on("end",function(){var n=o._ParseCookies(t.headers["set-cookie"]);e(null,{FedAuth:o._GetCookie(n,"FedAuth").value,rtFa:o._GetCookie(n,"rtFa").value})})});u.end(n)},o._RequestToken=function(t,e){var n=o._BuildSamlRequest({username:t.username,password:t.password,endpoint:t.endpoint}),r={method:"POST",host:t.sts.host,path:t.sts.path,headers:{"Content-Length":n.length}},i=https.request(r,function(t){var e="";t.setEncoding("utf8"),t.on("data",function(t){e+=t}),t.on("end",function(){})});i.end(n)},o}();t.RestService=o;var r=function(){function t(t,e){}return t}();t.List=r}(SP||(SP={})),module.exports=SP;